<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chord Practice</title>
  <style>
    /* Dark background for the entire page */
    body {
      background-color: #333;
      color: #fff;
      font-family: sans-serif;
      margin: 20px;
    }
    .controls {
      margin-bottom: 20px;
    }
    .controls label {
      margin-right: 10px;
    }
    #keyboard {
      white-space: nowrap;
    }
    .key {
      display: inline-block;
      position: relative; /* for placing markers absolutely */
      box-sizing: border-box;
      user-select: none;
      border: 1px solid #666;
      margin: 0;
      cursor: pointer; /* so user sees clickable */
    }
    /* White keys: aligned at bottom */
    .white-key {
      width: 40px;
      height: 150px;
      background: #fff;
      vertical-align: bottom;
      z-index: 1;
    }
    /* Black keys: aligned at top */
    .black-key {
      width: 25px;
      height: 100px;
      background: #000;
      color: #fff;
      vertical-align: top;
      z-index: 2;
      margin: 0 -12px; /* overlap for a piano-like look */
    }
    /* Pink circle to mark the *lowest* note in the chord */
    .lowest-note-marker {
      position: absolute;
      bottom: 5px;
      left: 0;
      right: 0;
      margin: auto;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #ff8484; /* pinkish */
    }
    /* Green circle to show user-selected notes (other than lowest note) */
    .selected-note-marker {
      position: absolute;
      bottom: 5px;
      left: 0;
      right: 0;
      margin: auto;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #84ff84; /* greenish */
    }
  </style>
</head>
<body>

<h1>Chord Practice</h1>

<div class="controls">
  <label for="lowestNoteSelect">Lowest Note:</label>
  <select id="lowestNoteSelect"></select>

  <label for="highestNoteSelect">Highest Note:</label>
  <select id="highestNoteSelect"></select>

  <label for="numNotesSelect"># of Notes:</label>
  <select id="numNotesSelect">
    <option value="2">2</option>
    <option value="3" selected>3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
  </select>
</div>

<div class="controls">
  <button id="nextBtn">Next</button>
  <button id="playGeneratedBtn">Play Generated Chord</button>
  <button id="playSelectedBtn">Play Selected Notes</button>
</div>

<div id="keyboard"></div>

<script>
  // Extended note list from C2 up to C7
  const ALL_NOTES = [
    { name: "C2",  freq: 65.41 },
    { name: "C#2", freq: 69.30 },
    { name: "D2",  freq: 73.42 },
    { name: "D#2", freq: 77.78 },
    { name: "E2",  freq: 82.41 },
    { name: "F2",  freq: 87.31 },
    { name: "F#2", freq: 92.50 },
    { name: "G2",  freq: 98.00 },
    { name: "G#2", freq: 103.83 },
    { name: "A2",  freq: 110.00 },
    { name: "A#2", freq: 116.54 },
    { name: "B2",  freq: 123.47 },

    { name: "C3",  freq: 130.81 },
    { name: "C#3", freq: 138.59 },
    { name: "D3",  freq: 146.83 },
    { name: "D#3", freq: 155.56 },
    { name: "E3",  freq: 164.81 },
    { name: "F3",  freq: 174.61 },
    { name: "F#3", freq: 185.00 },
    { name: "G3",  freq: 196.00 },
    { name: "G#3", freq: 207.65 },
    { name: "A3",  freq: 220.00 },
    { name: "A#3", freq: 233.08 },
    { name: "B3",  freq: 246.94 },

    { name: "C4",  freq: 261.63 },
    { name: "C#4", freq: 277.18 },
    { name: "D4",  freq: 293.66 },
    { name: "D#4", freq: 311.13 },
    { name: "E4",  freq: 329.63 },
    { name: "F4",  freq: 349.23 },
    { name: "F#4", freq: 369.99 },
    { name: "G4",  freq: 392.00 },
    { name: "G#4", freq: 415.30 },
    { name: "A4",  freq: 440.00 },
    { name: "A#4", freq: 466.16 },
    { name: "B4",  freq: 493.88 },

    { name: "C5",  freq: 523.25 },
    { name: "C#5", freq: 554.37 },
    { name: "D5",  freq: 587.33 },
    { name: "D#5", freq: 622.25 },
    { name: "E5",  freq: 659.25 },
    { name: "F5",  freq: 698.46 },
    { name: "F#5", freq: 739.99 },
    { name: "G5",  freq: 783.99 },
    { name: "G#5", freq: 830.61 },
    { name: "A5",  freq: 880.00 },
    { name: "A#5", freq: 932.33 },
    { name: "B5",  freq: 987.77 },

    { name: "C6",  freq: 1046.50 },
    { name: "C#6", freq: 1108.73 },
    { name: "D6",  freq: 1174.66 },
    { name: "D#6", freq: 1244.51 },
    { name: "E6",  freq: 1318.51 },
    { name: "F6",  freq: 1396.91 },
    { name: "F#6", freq: 1479.98 },
    { name: "G6",  freq: 1567.98 },
    { name: "G#6", freq: 1661.22 },
    { name: "A6",  freq: 1760.00 },
    { name: "A#6", freq: 1864.66 },
    { name: "B6",  freq: 1975.53 },

    { name: "C7",  freq: 2093.00 },
  ];

  let currentNotes = [];         // Notes in the currently selected range
  let keyElements  = [];         // Corresponding piano key elements
  let randomChord  = [];         // The generated chord (array: { index, freq })
  let selectedKeys = new Set();  // A set of indices that the user has selected
  let lowestChordIndex = null;   // The index (into currentNotes) of the chord's lowest note

  let activeAudioCtx = null;
  let activeGain = null;
  let activeOscillators = [];

  // Fade times for chord playback (seconds)
  const FADE_IN_TIME  = 0.01;
  const FADE_OUT_TIME = 0.3;

  // DOM elements
  const keyboardDiv       = document.getElementById("keyboard");
  const lowestNoteSelect  = document.getElementById("lowestNoteSelect");
  const highestNoteSelect = document.getElementById("highestNoteSelect");
  const numNotesSelect    = document.getElementById("numNotesSelect");
  const nextBtn           = document.getElementById("nextBtn");
  const playGeneratedBtn  = document.getElementById("playGeneratedBtn");
  const playSelectedBtn   = document.getElementById("playSelectedBtn");

  //------------------------------------------------------------
  // 1) Populate dropdowns for lowest/highest note
  //------------------------------------------------------------
  function populateNoteSelects() {
    ALL_NOTES.forEach((note, index) => {
      const optionLow  = document.createElement("option");
      optionLow.value  = index;
      optionLow.textContent = note.name;

      const optionHigh = document.createElement("option");
      optionHigh.value = index;
      optionHigh.textContent = note.name;

      lowestNoteSelect.appendChild(optionLow);
      highestNoteSelect.appendChild(optionHigh);
    });

    // Default: C3 -> C5
    const defaultLowest  = ALL_NOTES.findIndex(n => n.name === "C3");
    const defaultHighest = ALL_NOTES.findIndex(n => n.name === "C5");
    if (defaultLowest !== -1)  lowestNoteSelect.value  = defaultLowest;
    if (defaultHighest !== -1) highestNoteSelect.value = defaultHighest;
  }

  populateNoteSelects();

  //------------------------------------------------------------
  // 2) Build the keyboard for the chosen range
  //------------------------------------------------------------
  function buildKeyboard() {
    keyboardDiv.innerHTML = "";
    keyElements = [];

    const lowestIndex  = parseInt(lowestNoteSelect.value, 10);
    const highestIndex = parseInt(highestNoteSelect.value, 10);

    if (isNaN(lowestIndex) || isNaN(highestIndex)) return;

    const start = Math.min(lowestIndex, highestIndex);
    const end   = Math.max(lowestIndex, highestIndex);
    currentNotes = ALL_NOTES.slice(start, end + 1);

    currentNotes.forEach((note, localIdx) => {
      const keyDiv = document.createElement("div");
      keyDiv.classList.add("key");
      if (note.name.includes("#")) {
        keyDiv.classList.add("black-key");
      } else {
        keyDiv.classList.add("white-key");
      }
      // Add event listener for toggling selection
      keyDiv.addEventListener("click", () => toggleKeySelection(localIdx));
      keyboardDiv.appendChild(keyDiv);
      keyElements.push(keyDiv);
    });
  }

  //------------------------------------------------------------
  // 3) Generate a random chord (sort by ascending frequency)
  //------------------------------------------------------------
  function generateChord() {
    // Clear old markers
    clearKeyMarkings();
    selectedKeys.clear();

    let howMany = parseInt(numNotesSelect.value, 10) || 3;
    if (howMany > currentNotes.length) {
      howMany = currentNotes.length;
    }

    // Shuffle array of indices
    const indices = [...Array(currentNotes.length).keys()];
    for (let i = indices.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [indices[i], indices[j]] = [indices[j], indices[i]];
    }
    // Pick first howMany
    const chosenIndices = indices.slice(0, howMany);

    // Build chord array
    randomChord = chosenIndices.map(idx => ({
      index: idx,
      freq: currentNotes[idx].freq
    }));

    // Sort chord by ascending freq
    randomChord.sort((a, b) => a.freq - b.freq);

    // Mark the lowest note
    lowestChordIndex = randomChord[0].index;
    addLowestNoteMarker(lowestChordIndex);

    // The lowest note is always selected
    selectedKeys.add(lowestChordIndex);
  }

  //------------------------------------------------------------
  // 4) Add marker to show the lowest note
  //------------------------------------------------------------
  function addLowestNoteMarker(localIdx) {
    const keyDiv = keyElements[localIdx];
    if (!keyDiv) return;
    const marker = document.createElement("div");
    marker.className = "lowest-note-marker";
    keyDiv.appendChild(marker);
  }

  //------------------------------------------------------------
  // Add a marker to show a user-selected note (green circle)
  //------------------------------------------------------------
  function addSelectionMarker(localIdx) {
    // If it's the lowest note, we do NOT add another marker:
    // (lowest note has its own pink marker)
    if (localIdx === lowestChordIndex) return;

    const marker = document.createElement("div");
    marker.className = "selected-note-marker";
    keyElements[localIdx].appendChild(marker);
  }

  //------------------------------------------------------------
  // Remove the selection marker from a given key (if present)
  //------------------------------------------------------------
  function removeSelectionMarker(localIdx) {
    // Don't remove the pink marker from the lowest note
    if (localIdx === lowestChordIndex) return;

    const marker = keyElements[localIdx].querySelector(".selected-note-marker");
    if (marker) {
      keyElements[localIdx].removeChild(marker);
    }
  }

  //------------------------------------------------------------
  // Toggle user selection of a key (except lowest chord note)
  //------------------------------------------------------------
  function toggleKeySelection(localIdx) {
    if (localIdx === lowestChordIndex) {
      // The lowest note is always considered selected; do nothing
      return;
    }

    if (selectedKeys.has(localIdx)) {
      // Unselect
      selectedKeys.delete(localIdx);
      removeSelectionMarker(localIdx);
    } else {
      // Select
      selectedKeys.add(localIdx);
      addSelectionMarker(localIdx);
    }
  }

  //------------------------------------------------------------
  // Remove all markers (lowest & selection) from keys
  //------------------------------------------------------------
  function clearKeyMarkings() {
    keyElements.forEach(keyDiv => {
      // Remove lowest-note marker if present
      const lowest = keyDiv.querySelector(".lowest-note-marker");
      if (lowest) keyDiv.removeChild(lowest);

      // Remove selection marker if present
      const sel = keyDiv.querySelector(".selected-note-marker");
      if (sel) keyDiv.removeChild(sel);
    });
  }

  //------------------------------------------------------------
  // Start/stop playback for a set of frequencies
  //------------------------------------------------------------
  function startChordPlayback(frequencies) {
    if (!frequencies || frequencies.length === 0) return;
    stopChordPlayback();

    activeAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const now = activeAudioCtx.currentTime;

    activeGain = activeAudioCtx.createGain();
    activeGain.connect(activeAudioCtx.destination);
    activeGain.gain.setValueAtTime(0, now);
    activeGain.gain.linearRampToValueAtTime(1, now + FADE_IN_TIME);

    activeOscillators = [];
    frequencies.forEach(freq => {
      const fGain = activeAudioCtx.createGain();
      fGain.gain.value = 0.12;
      fGain.connect(activeGain);

      const secondGain = activeAudioCtx.createGain();
      secondGain.gain.value = 0.05;
      secondGain.connect(activeGain);

      const thirdGain = activeAudioCtx.createGain();
      thirdGain.gain.value = 0.03;
      thirdGain.connect(activeGain);

      const oscFund = activeAudioCtx.createOscillator();
      oscFund.type = "sine";
      oscFund.frequency.value = freq;
      oscFund.connect(fGain);
      oscFund.start(now);

      const osc2 = activeAudioCtx.createOscillator();
      osc2.type = "sine";
      osc2.frequency.value = freq * 2;
      osc2.connect(secondGain);
      osc2.start(now);

      const osc3 = activeAudioCtx.createOscillator();
      osc3.type = "sine";
      osc3.frequency.value = freq * 3;
      osc3.connect(thirdGain);
      osc3.start(now);

      activeOscillators.push(oscFund, osc2, osc3);
    });
  }

  function stopChordPlayback() {
    if (!activeAudioCtx) return;
    const now = activeAudioCtx.currentTime;
    activeGain.gain.cancelScheduledValues(now);
    activeGain.gain.setValueAtTime(activeGain.gain.value, now);
    activeGain.gain.linearRampToValueAtTime(0, now + FADE_OUT_TIME);
    activeOscillators.forEach(osc => {
      try { osc.stop(now + FADE_OUT_TIME); } catch (e) {}
    });
    setTimeout(() => {
      if (activeAudioCtx) {
        activeAudioCtx.close();
        activeAudioCtx = null;
        activeGain = null;
        activeOscillators = [];
      }
    }, (FADE_OUT_TIME + 0.05) * 1000);
  }

  //------------------------------------------------------------
  // Play the generated chord (all notes simultaneously)
  //------------------------------------------------------------
  function startGeneratedChord() {
    if (!randomChord || randomChord.length === 0) return;
    const freqs = randomChord.map(obj => obj.freq);
    startChordPlayback(freqs);
  }

  //------------------------------------------------------------
  // Play the user's currently selected notes
  //------------------------------------------------------------
  function startSelectedChord() {
    if (selectedKeys.size === 0) return;
    const freqs = [];
    selectedKeys.forEach(idx => {
      freqs.push(currentNotes[idx].freq);
    });
    startChordPlayback(freqs);
  }

  //------------------------------------------------------------
  // Event listeners
  //------------------------------------------------------------
  lowestNoteSelect.addEventListener("change", () => {
    buildKeyboard();
    generateChord();
  });
  highestNoteSelect.addEventListener("change", () => {
    buildKeyboard();
    generateChord();
  });
  numNotesSelect.addEventListener("change", () => {
    generateChord();
  });

  nextBtn.addEventListener("click", () => {
    buildKeyboard();
    generateChord();
  });

  playGeneratedBtn.addEventListener("pointerdown", startGeneratedChord);
  playGeneratedBtn.addEventListener("pointerup", stopChordPlayback);
  playGeneratedBtn.addEventListener("pointerleave", stopChordPlayback);
  playGeneratedBtn.addEventListener("pointercancel", stopChordPlayback);

  playSelectedBtn.addEventListener("pointerdown", startSelectedChord);
  playSelectedBtn.addEventListener("pointerup", stopChordPlayback);
  playSelectedBtn.addEventListener("pointerleave", stopChordPlayback);
  playSelectedBtn.addEventListener("pointercancel", stopChordPlayback);

  // Initialize
  buildKeyboard();
  generateChord();
</script>

</body>
</html>
