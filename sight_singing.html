<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sight-Singing Practice</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background-color: #343a40;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
    #keyboard {
      white-space: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 10px;
    }
    .key {
      display: inline-block;
      position: relative;
      box-sizing: border-box;
      user-select: none;
      border: 1px solid #666;
      margin: 0;
      overflow: hidden;
    }
    .white-key {
      width: 60px;
      height: 225px;
      background: #fff;
      vertical-align: bottom;
      z-index: 1;
    }
    .black-key {
      width: 38px;
      height: 150px;
      background: #000;
      color: #fff;
      vertical-align: top;
      z-index: 2;
      margin: 0 -18px;
    }
    .sequence-label {
      position: absolute;
      bottom: 8px;
      left: 0;
      right: 0;
      text-align: center;
      font-weight: bold;
      font-size: 1.2em;
      color: #ff8484;
    }

    @media (max-width: 576px) {
      .white-key {
        width: 40px;
        height: 170px;
      }
      .black-key {
        width: 25px;
        height: 110px;
        margin: 0 -12px;
      }
      h1 {
        font-size: 1.5rem;
      }
      .sequence-label {
        bottom: 4px;
        font-size: 1em;
      }
      .control-buttons .btn {
        display: block;
        width: 100%;
        margin-bottom: 0.5rem;
      }
      .control-buttons .btn:last-child {
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body class="bg-dark text-light">
<div class="container py-4">
  <h1 class="text-center mb-4">Sight-Singing Practice</h1>

  <div class="row g-3 align-items-end mb-4">
    <div class="col-md-4">
      <label for="lowestNoteSelect" class="form-label">Lowest Note</label>
      <select id="lowestNoteSelect" class="form-select form-select-sm"></select>
    </div>
    <div class="col-md-4">
      <label for="highestNoteSelect" class="form-label">Highest Note</label>
      <select id="highestNoteSelect" class="form-select form-select-sm"></select>
    </div>
    <div class="col-md-4">
      <label for="numNotesInput" class="form-label"># of Notes</label>
      <input type="number" id="numNotesInput" value="3" min="1" max="50" class="form-control form-control-sm">
    </div>
  </div>

  <div class="mb-4 control-buttons">
    <button id="nextBtn" class="btn btn-primary me-2">Next</button>
    <button id="playBtn" class="btn btn-success me-2">Play</button>
    <button id="playFirstBtn" class="btn btn-success">Play First</button>
  </div>

  <div id="keyboard" class="mb-3"></div>
</div>

<script>
  // Build note list from C2 up to C7
  const ALL_NOTES = [];
  const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
  for (let midi = 36; midi <= 96; midi++) {
    const octave = Math.floor(midi / 12) - 1;
    const name = NOTE_NAMES[midi % 12] + octave;
    const freq = 440 * Math.pow(2, (midi - 69) / 12);
    ALL_NOTES.push({ name, freq });
  }

  let currentNotes = [];
  let keyElements  = [];
  let randomSequence = [];

  // DOM elements
  const keyboardDiv       = document.getElementById("keyboard");
  const lowestNoteSelect  = document.getElementById("lowestNoteSelect");
  const highestNoteSelect = document.getElementById("highestNoteSelect");
  const numNotesInput     = document.getElementById("numNotesInput");
  const nextBtn           = document.getElementById("nextBtn");
  const playBtn           = document.getElementById("playBtn");
  const playFirstBtn      = document.getElementById("playFirstBtn");

  // ------------------------------------------------------------
  // 1) Populate dropdowns for lowest/highest note
  // ------------------------------------------------------------
  function populateNoteSelects() {
    ALL_NOTES.forEach((note, index) => {
      const optionLow = document.createElement("option");
      optionLow.value = index;
      optionLow.textContent = note.name;

      const optionHigh = document.createElement("option");
      optionHigh.value = index;
      optionHigh.textContent = note.name;

      lowestNoteSelect.appendChild(optionLow);
      highestNoteSelect.appendChild(optionHigh);
    });

    // Default: C3 -> C5
    const defaultLowest  = ALL_NOTES.findIndex(n => n.name === "C3");
    const defaultHighest = ALL_NOTES.findIndex(n => n.name === "C5");
    if (defaultLowest !== -1)  lowestNoteSelect.value  = defaultLowest;
    if (defaultHighest !== -1) highestNoteSelect.value = defaultHighest;
  }

  populateNoteSelects();

  // ------------------------------------------------------------
  // 2) Build the keyboard for the chosen range
  // ------------------------------------------------------------
  function buildKeyboard() {
    // Clear existing
    keyboardDiv.innerHTML = "";
    keyElements = [];

    // Parse user-chosen range
    const lowestIndex  = parseInt(lowestNoteSelect.value, 10);
    const highestIndex = parseInt(highestNoteSelect.value, 10);
    if (isNaN(lowestIndex) || isNaN(highestIndex)) return;

    const start = Math.min(lowestIndex, highestIndex);
    const end   = Math.max(lowestIndex, highestIndex);
    currentNotes = ALL_NOTES.slice(start, end + 1);

    currentNotes.forEach(note => {
      const keyDiv = document.createElement("div");
      keyDiv.classList.add("key");

      if (note.name.includes("#")) {
        keyDiv.classList.add("black-key");
      } else {
        keyDiv.classList.add("white-key");
      }
      keyboardDiv.appendChild(keyDiv);
      keyElements.push(keyDiv);
    });
  }

  // ------------------------------------------------------------
  // 3) Generate random sequence (unique notes)
  // ------------------------------------------------------------
  function generateSequence() {
    // Remove old labels
    keyElements.forEach(key => {
      const oldLabel = key.querySelector(".sequence-label");
      if (oldLabel) {
        key.removeChild(oldLabel);
      }
    });

    randomSequence = [];

    let howMany = parseInt(numNotesInput.value, 10) || 3;
    if (howMany > currentNotes.length) {
      howMany = currentNotes.length;
    }

    // Shuffle array of indices
    const indices = [...Array(currentNotes.length).keys()];
    for (let i = indices.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [indices[i], indices[j]] = [indices[j], indices[i]];
    }

    // Pick first howMany
    const selected = indices.slice(0, howMany);
    randomSequence = selected.map(idx => ({
      index: idx,
      freq: currentNotes[idx].freq
    }));

    // Label each chosen key
    randomSequence.forEach((item, i) => {
      const labelSpan = document.createElement("span");
      labelSpan.className = "sequence-label";
      labelSpan.textContent = (i + 1).toString();
      keyElements[item.index].appendChild(labelSpan);
    });
  }

  // ------------------------------------------------------------
  // Helper: play a single note (with fundamental + overtones)
  // ------------------------------------------------------------
  function playOneNote(audioCtx, frequency, startTime, duration) {
    const stopTime = startTime + duration;

    const mainGain = audioCtx.createGain();
    mainGain.connect(audioCtx.destination);

    mainGain.gain.setValueAtTime(0, startTime);
    mainGain.gain.linearRampToValueAtTime(1, startTime + 0.01);
    mainGain.gain.linearRampToValueAtTime(0, stopTime - 0.01);

    const amps = [0.12, 0.05, 0.03];
    amps.forEach((amp, i) => {
      const gain = audioCtx.createGain();
      gain.gain.value = amp;
      gain.connect(mainGain);

      const osc = audioCtx.createOscillator();
      osc.type = "sine";
      osc.frequency.value = frequency * (i + 1);
      osc.connect(gain);
      osc.start(startTime);
      osc.stop(stopTime);
    });
  }

  // ------------------------------------------------------------
  // 4) Play the entire random sequence with fade and partials
  // ------------------------------------------------------------
  function playSequence() {
    if (randomSequence.length === 0) return;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const now = audioCtx.currentTime;
    const noteDuration = 0.8;
    const gap = 0.1;

    randomSequence.forEach((noteObj, i) => {
      const startTime = now + i * (noteDuration + gap);
      playOneNote(audioCtx, noteObj.freq, startTime, noteDuration);
    });
  }

  // ------------------------------------------------------------
  // 5) Play only the first note
  // ------------------------------------------------------------
  function playFirstNote() {
    if (randomSequence.length === 0) return;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const now = audioCtx.currentTime;
    const noteDuration = 1.0;

    const firstFreq = randomSequence[0].freq;
    playOneNote(audioCtx, firstFreq, now, noteDuration);
  }

  // ------------------------------------------------------------
  // On-change events for the note selects
  // ------------------------------------------------------------
  lowestNoteSelect.addEventListener("change", () => {
    buildKeyboard();
    generateSequence();
  });
  highestNoteSelect.addEventListener("change", () => {
    buildKeyboard();
    generateSequence();
  });

  // Buttons
  nextBtn.addEventListener("click", generateSequence);
  playBtn.addEventListener("click", playSequence);
  playFirstBtn.addEventListener("click", playFirstNote);

  // Initial
  buildKeyboard();
  generateSequence();
</script>

</body>
</html>
